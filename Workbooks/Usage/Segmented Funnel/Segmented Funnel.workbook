{
    "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json",
    "version": "Notebook/1.0",
    "isLocked": true,
    "items": [
        {
            "type": 1,
            "content": {
                "json": "## <a name=\"segmented-funnel\"></a><span data-ttu-id=\"4a6d7-101\">åˆ†æ®µæ¼æ–—å›¾</span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-101\">Segmented Funnel</span></span>\n---\n<span data-ttu-id=\"4a6d7-102\">æ¼æ–—å›¾æ˜¯ä¸€ç§è®¡ç®—åº”ç”¨ä¸­ç‰¹å®šç”¨æˆ·è¡Œä¸ºçš„è½¬åŒ–ç‡çš„æœ‰æ•ˆå·¥å…·ã€‚</span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-102\">Funnels are an effective tool in calculating conversions rates of specific user behaviors in your app.</span></span> <span data-ttu-id=\"4a6d7-103\">ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥è¡¡é‡è®¿é—®ä½ åº”ç”¨çš„ç”¨æˆ·æ‰§è¡Œæ„Ÿå…´è¶£çš„äº‹ä»¶ï¼ˆä¾‹å¦‚åœ¨åº”ç”¨ä¸­è¿›è¡Œè´­ä¹°ï¼‰çš„é¢‘ç‡ã€‚</span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-103\">For instance, it could measure the rate at which users who come to your app perform an interesting event -- like make a purchase from within your app.</span></span>\n\n<span data-ttu-id=\"4a6d7-104\">åˆ†æ®µæ¼æ–—å›¾å¯ä»¥åˆ†æè·¨æ„Ÿå…´è¶£ç»´åº¦ï¼ˆä¾‹å¦‚è·¨å›½å®¶/åœ°åŒºã€åº”ç”¨ç‰ˆæœ¬æˆ–è®¾å¤‡ç±»å‹ï¼‰çš„è½¬åŒ–ç‡ã€‚</span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-104\">Segmenting a funnel allows the analysis of conversion rates across an interesting dimension -- say across countries, app versions or device type.</span></span> <span data-ttu-id=\"4a6d7-105\">è¿™æ ·å¯ä»¥è¯†åˆ«æ½œåœ¨è½¬åŒ–é—®é¢˜ï¼Œä¾‹å¦‚ï¼š</span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-105\">This allows you to identify potential conversions issues like:</span></span>\n* <span data-ttu-id=\"4a6d7-106\">åŠ æ‹¿å¤§çš„è½¬æ¢ç‡æ¯”ç¾å›½ä½ 10ï¼…ï¼Œæˆ–è€… </span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-106\">Conversion in Canada is 10% lower than in the United States, or</span></span> \n* <span data-ttu-id=\"4a6d7-107\">åœ¨ Android è®¾å¤‡ä¸Šè¿›è¡Œè´­ä¹°çš„ç”¨æˆ·ä¼¼ä¹å¹¶ä¸å¤šã€‚</span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-107\">Not many users seem to be purchasing on Android devices.</span></span>\n\n<span data-ttu-id=\"4a6d7-108\">ä½¿ç”¨æ­¤æŠ¥è¡¨å¯åœ¨é€‰æ‹©çš„â€œæ ‡å‡†â€æˆ–â€œè‡ªå®šä¹‰â€ç»´åº¦ä¸Šåˆ›å»ºåˆ†æè½¬åŒ–ç‡ã€‚</span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-108\">Use this report to create analyze conversion rates across a _standard_ or _custom_ dimension of your choice.</span></span>"
            },
            "conditionalVisibility": null,
            "halfWidth": false
        },
        {
            "type": 9,
            "content": {
                "version": "KqlParameterItem/1.0",
                "query": "",
                "crossComponentResources": [],
                "parameters": [
                    {
                        "id": "6ce4c5c1-5098-4b1a-82b4-6073f3a75b5e",
                        "version": "KqlParameterItem/1.0",
                        "name": "TimeRange",
                        "type": 2,
                        "description": null,
                        "isRequired": true,
                        "multiSelect": null,
                        "query": "datatable(key:string, display:string) \r\n[ \r\n\">= ago(1d)\", \"Last 24 hours\", \r\n\">= ago(2d)\", \"Last 48 hours\", \r\n\">= ago(7d)\", \"Last 7 days\", \r\n\">= ago(14d)\", \"Last 14 days\", \r\n\">= ago(30d)\", \"Last 30 days\", \r\n\">= ago(90d)\", \"Last 90 days\", \r\n\"between(ago(14d)..ago(7d))\", \"Previous Week\", \r\n\"between(ago(60d)..ago(30d))\", \"Previous Month\", \r\n] ",
                        "value": ">= ago(1d)"
                    },
                    {
                        "id": "77a13f3c-932e-4ef1-ad81-ce9de620588d",
                        "version": "KqlParameterItem/1.0",
                        "name": "ConversionScope",
                        "type": 2,
                        "description": "<span data-ttu-id=\"4a6d7-109\">é€‰æ‹©è½¬åŒ–è®¡ç®—çš„èŒƒå›´ã€‚</span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-109\">Select the scope for your conversion calculations.</span></span> <span data-ttu-id=\"4a6d7-110\">åœ¨â€œä¼šè¯â€èŒƒå›´å†…ï¼Œé¡¶éƒ¨å’Œåº•éƒ¨çš„æ´»åŠ¨éƒ½éœ€è¦åœ¨åŒä¸€ä¸ªä¼šè¯ä¸­è¿›è¡Œï¼Œä»¥è®¡å…¥è½¬åŒ–ã€‚</span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-110\">In the Session scope, both the top and bottom activities need to happen in the same session to count towards conversion.</span></span> <span data-ttu-id=\"4a6d7-111\">å¯¹äºä¸¤ä¸ªç”¨æˆ·èŒƒå›´ï¼Œç”¨æˆ·å¯åœ¨ä¸åŒçš„ä¼šè¯ä¸­å®Œæˆè¿™ä¸¤é¡¹æ´»åŠ¨ã€‚</span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-111\">For both User scopes, the user is allowed to have done both activities in different sessions.</span></span>",
                        "isRequired": true,
                        "multiSelect": null,
                        "query": "datatable(key:string, display:string)\n[\n\"user_Id\", \"Anonymous Users\", \n\"user_AuthenticatedId\", \"Authenticated Users\",\"session_Id\", \"Sessions\",\n]",
                        "value": "session_Id"
                    }
                ]
            },
            "conditionalVisibility": null,
            "halfWidth": false
        },
        {
            "type": 1,
            "content": {
                "json": "### <a name=\"set-the-top-of-the-funnel\"></a><span data-ttu-id=\"4a6d7-112\">è®¾ç½®æ¼æ–—å›¾çš„é¡¶éƒ¨</span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-112\">Set the Top of the Funnel</span></span>"
            },
            "conditionalVisibility": null,
            "halfWidth": false
        },
        {
            "type": 9,
            "content": {
                "version": "KqlParameterItem/1.0",
                "query": "",
                "crossComponentResources": [],
                "parameters": [
                    {
                        "id": "4c766401-680d-477b-a1a2-27b3cc54f4aa",
                        "version": "KqlParameterItem/1.0",
                        "name": "TopStep",
                        "type": 2,
                        "description": "<span data-ttu-id=\"4a6d7-113\">é€‰æ‹©æ„æˆæ¼æ–—å›¾é¡¶éƒ¨çš„æ´»åŠ¨ã€‚</span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-113\">Select the activities that form the top of your funnel.</span></span>",
                        "isRequired": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "query": "union customEvents, pageViews\r\n| where timestamp >= ago(7d)\r\n| summarize count() by name\r\n| order by count_ desc\r\n| project Id=name, Title=name, Selected=false\r\n| union (\r\ndatatable(Id:string, Title:string, Selected:boolean)[\r\n'*', 'All Events and Page Views', true\r\n]\r\n)"
                    },
                    {
                        "id": "d459a38a-f60c-43d1-8ed4-16197bbda3fb",
                        "version": "KqlParameterItem/1.0",
                        "name": "TopFilters",
                        "type": 1,
                        "description": "<span data-ttu-id=\"4a6d7-114\">ç”¨äºè¿›ä¸€æ­¥ç­›é€‰é¡¶éƒ¨æ­¥éª¤çš„åˆ†ææŸ¥è¯¢ä»£ç ç‰‡æ®µã€‚</span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-114\">An analytics query snippet to further filter the top step.</span></span> <span data-ttu-id=\"4a6d7-115\">ç¤ºä¾‹ï¼š| where application_Version = '1.0'</span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-115\">Example: | where application_Version = '1.0'</span></span>",
                        "isRequired": false
                    },
                    {
                        "id": "eefc5a11-0078-47a0-8d41-019ea7476306",
                        "version": "KqlParameterItem/1.0",
                        "name": "SegmentBy",
                        "type": 2,
                        "description": null,
                        "isRequired": true,
                        "multiSelect": null,
                        "query": "datatable(value:string, text:string)[\r\n'itemType', 'âŒ None',\r\n'name', 'ğŸ“› Activity',\r\n'cloud_RoleInstance', 'ğŸ–¥ï¸ Machine',\r\n'client_CountryOrRegion', 'ğŸ“ Country or Region',\r\n'client_StateOrProvince', 'ğŸ“ State or Province',\r\n'client_City', 'ğŸ“ City',\r\n'client_Browser', 'ğŸŒ Client Browser',\r\n'client_OS', 'ï¸ï¸ğŸ–¥ï¸ Client Operating System',\r\n'client_Model', 'ğŸ“± Client Model',\r\n'application_Version', 'âšª Application Version',\r\n'operation_Name', 'âšª Operation',\r\n]\r\n| union (union pageViews, customEvents\r\n| where timestamp >= ago(1d)\r\n| where name in ({TopStep}) or '*' in ({TopStep})\r\n| project customDimensions \r\n| summarize schema = buildschema(customDimensions) \r\n| mvexpand schema\r\n| extend e = extract(@'{\"(.+)\":.+}', 1, tostring(schema))\r\n| project text = strcat('â„ï¸ ', e), value = strcat('customDimensions[\"', e, '\"]'))",
                        "value": "client_CountryOrRegion"
                    }
                ]
            },
            "conditionalVisibility": null,
            "halfWidth": false
        },
        {
            "type": 1,
            "content": {
                "json": "### <a name=\"set-the-bottom-of-the-funnel\"></a><span data-ttu-id=\"4a6d7-116\">è®¾ç½®æ¼æ–—å›¾åº•éƒ¨</span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-116\">Set the Bottom of the Funnel</span></span>"
            },
            "conditionalVisibility": null,
            "halfWidth": false
        },
        {
            "type": 9,
            "content": {
                "version": "KqlParameterItem/1.0",
                "query": "",
                "crossComponentResources": [],
                "parameters": [
                    {
                        "id": "6362855e-7d02-437d-964e-b526259323dc",
                        "version": "KqlParameterItem/1.0",
                        "name": "BottomStep",
                        "type": 2,
                        "description": "<span data-ttu-id=\"4a6d7-117\">é€‰æ‹©æ„æˆæ¼æ–—å›¾åº•éƒ¨çš„æ´»åŠ¨</span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-117\">Select the activities that form the bottom of your funnel</span></span>",
                        "isRequired": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "query": "union customEvents, pageViews\r\n| where timestamp >= ago(7d)\r\n| summarize count() by name\r\n| order by count_ desc\r\n| project Id=name, Title=name, Selected=false\r\n| union (\r\ndatatable(Id:string, Title:string, Selected:boolean)[\r\n'*', 'All Events and Page Views', true\r\n]\r\n)"
                    },
                    {
                        "id": "86f23e20-64e4-44fe-80ba-74b0080ba276",
                        "version": "KqlParameterItem/1.0",
                        "name": "BottomFilters",
                        "type": 1,
                        "description": "<span data-ttu-id=\"4a6d7-118\">ç”¨äºè¿›ä¸€æ­¥ç­›é€‰åº•éƒ¨æ­¥éª¤çš„åˆ†ææŸ¥è¯¢ä»£ç ç‰‡æ®µã€‚</span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-118\">An analytics query snippet to further filter the bottom step.</span></span> <span data-ttu-id=\"4a6d7-119\">ç¤ºä¾‹ï¼š| where application_Version = '1.0'</span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-119\">Example: | where application_Version = '1.0'</span></span>",
                        "isRequired": false
                    }
                ]
            },
            "conditionalVisibility": null,
            "halfWidth": false
        },
        {
            "type": 1,
            "content": {
                "json": "# <a name=\"funnels\"></a><span data-ttu-id=\"4a6d7-120\">æ¼æ–—å›¾</span><span class=\"sxs-lookup\"><span data-stu-id=\"4a6d7-120\">Funnels</span></span>"
            },
            "conditionalVisibility": null,
            "halfWidth": false
        },
        {
            "type": 3,
            "content": {
                "version": "KqlItem/1.0",
                "query": "let data = union customEvents, pageViews\n| where timestamp {TimeRange};\nlet topUsers = data\n| where name in ({TopStep}) or '*' in ({TopStep})\n{TopFilters}\n| extend Dim1 = iff('{SegmentBy}' == 'itemType', 'Overall', {SegmentBy}) // reusing itemType to indicate no segmentation\n| summarize Min = min(timestamp) by {ConversionScope}, Dim1;\nlet bottomUsers = data\n| where name in ({BottomStep}) or '*' in ({BottomStep})\n{BottomFilters}\n| summarize Max = max(timestamp) by {ConversionScope};\nlet funnel = topUsers\n| join kind=inner (bottomUsers) on {ConversionScope}\n| where Max >= Min\n| summarize Bottom = dcount({ConversionScope}) by Dim1;\nlet funnelTop = topUsers\n| summarize Top=dcount({ConversionScope}) by Dim1\n| order by Top desc;\nlet multiFunnel = funnel\n| join kind=inner (funnelTop) on Dim1\n| project Dim1, Top, Bottom, Conversion = round(100.0 * Bottom / Top, 2)\n| extend Relevance = iff(Conversion == 0, pow(Top, 1.6), Top * 100 / Conversion);\nmultiFunnel\n| order by Relevance desc\n| project ['Segments'] = Dim1, [\"All Users\"] = Top, [\"Converted Users\"] = Bottom, [\"Conversion Rate (%)\"] = Conversion\n\n\n\n",
                "showQuery": false,
                "size": 0,
                "aggregation": 0,
                "showAnnotations": false,
                "gridSettings": {
                    "formatters": [
                        {
                            "columnMatch": "All Users|Converted Users",
                            "formatter": 4,
                            "formatOptions": {
                                "min": 0,
                                "max": null,
                                "palette": "blue"
                            }
                        },
                        {
                            "columnMatch": "Conversion Rate (%)",
                            "formatter": 4,
                            "formatOptions": {
                                "min": 0,
                                "max": 100,
                                "palette": "red"
                            }
                        }
                    ]
                }
            },
            "conditionalVisibility": null,
            "halfWidth": false
        }
    ]
}